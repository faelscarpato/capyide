<!DOCTYPE html>
<html lang="pt-BR" class="h-full" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>CapyIDE - Editor de Código com IA</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Pré-configuração do AMD loader do Monaco ANTES de carregar o loader -->
  <script>
    window.MONACO_VERSION = '0.44.0';
    window.MonacoCDN = `https://cdn.jsdelivr.net/npm/monaco-editor@${window.MONACO_VERSION}/min`;
    window.require = { paths: { vs: window.MonacoCDN + '/vs' } };
  </script>

  <!-- CSS principal do Monaco (evita falha do plugin vs/css) -->
  <link id="monaco-css" rel="stylesheet" data-name="vs/editor/editor.main"
        href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css" />
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <!-- ====== THEME CAPYUNIVERSE (drop-in) ====== -->
  <style id="capyuniverse-theme">
    :root{
      --cu-bg-0:#0b0b14; --cu-bg-1:#0f1024; --cu-bg-2:#141636;
      --cu-grid:#2a2e63; --cu-card:#0f0f22cc;
      --cu-cyan:#22d3ee; --cu-magenta:#f472d0; --cu-amber:#f59e0b; --cu-violet:#8b5cf6;
      --cu-text:#e6e6f0; --cu-text-dim:#aab;
      --cu-radius:16px; --cu-radius-lg:22px; --cu-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
      --cu-blur:12px;
    }
    body{ font-family: 'Inter', sans-serif; background:
      radial-gradient(1200px 700px at 70% -10%, rgba(139,92,246,.25), transparent 60%),
      radial-gradient(900px 600px at -10% 20%, rgba(34,211,238,.18), transparent 60%),
      var(--cu-bg-0); color:var(--cu-text); }

    /* cenário */
    .cu-stars{ position:fixed; inset:0; pointer-events:none; z-index:-2;
      background:
        radial-gradient(circle at 15% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px) 0 0/180px 180px,
        radial-gradient(circle at 75% 35%, rgba(255,255,255,.10) 0 1px, transparent 2px) 0 0/220px 220px,
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.08) 0 1px, transparent 2px) 0 0/260px 260px; }
    .cu-stage{ position:fixed; inset:auto 0 0 0; height:40vh; pointer-events:none; z-index:-1;
      background: linear-gradient( to top, rgba(10,10,22,.65), transparent 70%),
        repeating-linear-gradient( to right, transparent 0 38px, var(--cu-grid) 38px 39px),
        repeating-linear-gradient( to top,   transparent 0 38px, var(--cu-grid) 38px 39px);
      mask: linear-gradient(to top, black, transparent 80%); }

    /* header */
    .cu-header{ position:sticky; top:0; z-index:30; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(10,10,30,.7), rgba(10,10,30,.35));
      border-bottom: 1px solid rgba(255,255,255,.06); }
    .cu-brand{ display:flex; align-items:center; gap:.75rem; padding:10px 14px; }
    .cu-appname{ font-family: Syne, Inter, sans-serif; font-weight:800; letter-spacing:.4px; font-size:1.2rem; }
    .cu-chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .6rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:linear-gradient(120deg, rgba(34,211,238,.16), rgba(139,92,246,.16)); }

    /* containers */
    .cu-panel{ background:var(--cu-card); backdrop-filter: blur(var(--cu-blur));
      border-radius:var(--cu-radius-lg); box-shadow:var(--cu-shadow); border:1px solid rgba(255,255,255,.06); }
    .cu-panel-header{ display:flex; align-items:center; gap:.75rem; padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent); }

    /* botões / inputs */
    .cu-btn{ display:inline-flex; align-items:center; gap:.55rem; padding:.70rem 1rem; border-radius:var(--cu-radius);
      font-weight:600; border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(130deg, rgba(34,211,238,.18), rgba(244,114,208,.18));
      box-shadow:var(--cu-shadow); backdrop-filter: blur(6px); transition:.2s transform, .2s filter; }
    .cu-btn:hover{ transform: translateY(-1px); filter: drop-shadow(0 0 10px rgba(34,211,238,.45)) drop-shadow(0 0 24px rgba(244,114,208,.35)); }
    .cu-btn.primary{ background: linear-gradient(140deg, #0ea5e9 0%, #a855f7 45%, #f59e0b 100%); color:#fff; border-color:transparent; }
    .cu-input, .cu-textarea { width:100%; background:rgba(15,15,40,.6); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:.75rem .9rem; color:var(--cu-text); outline:none; }
    .cu-input:focus, .cu-textarea:focus { border-color: var(--cu-cyan); box-shadow: 0 0 0 3px rgba(34,211,238,.18); }

    /* tabs */
    .cu-tabs{ display:flex; gap:.35rem; align-items:center; padding:.4rem; background:rgba(255,255,255,.04);
      border-radius:12px; border:1px solid rgba(255,255,255,.06); }
    .cu-tab{ padding:.5rem .75rem; border-radius:10px; color:var(--cu-text-dim); border:1px solid transparent; cursor:pointer; }
    .cu-tab.active{ color:#fff; background:linear-gradient(120deg, rgba(34,211,238,.22), rgba(244,114,208,.22));
      border:1px solid rgba(255,255,255,.12); }

    /* editor/console */
    .cu-editor{ background:var(--cu-bg-1); border-radius:14px; border:1px solid rgba(255,255,255,.08); box-shadow:var(--cu-shadow); overflow:hidden; }
    .cu-output{ background:rgba(10,10,28,.8); border:1px solid rgba(255,255,255,.08); border-radius:14px; box-shadow:var(--cu-shadow); overflow:auto; }
    .cu-output pre{ font-family:"JetBrains Mono", ui-monospace, Menlo, Consolas, monospace; font-size:.9rem; line-height:1.5; padding:1rem; }

    /* monaco tweaks */
    .monaco-editor, .monaco-editor-background{ background-color:#0f1024 !important; }
    .monaco-editor .margin{ background-color:#0f1024 !important; }
    .monaco-editor .current-line{ background-color: rgba(255,255,255,.04) !important; }
    .monaco-editor .scrollbar > .slider{ background:linear-gradient(120deg, #22d3ee, #f472d0) !important; }

    /* animações originais */
    .slide-out-left { animation: slideOutLeft 0.4s ease-in-out forwards; }
    .slide-in-right { animation: slideInRight 0.4s ease-in-out forwards; }
    .slide-in-left { animation: slideInLeft 0.4s ease-in-out forwards; }
    @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* util */
    .muted{ color:var(--cu-text-dim); }
  </style>

  <style>
    #previewFrame { width: 100%; height: 100%; border: none; background: white; }
    #generateBtn { transition: all 0.25s ease; transform: scale(1); }
    #generateBtn:hover { transform: scale(1.03); box-shadow: 0 8px 25px rgba(163, 230, 53, 0.25); }
    #generateBtn:active { transform: scale(0.98); }
    #fallbackEditor { display:none; width:100%; height:100%; background:#0b0b0b; color:#e5e7eb; border:none; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:14px; }
  </style>
</head>
<body class="text-white h-full overflow-hidden">
  <!-- cenário -->
  <div class="cu-stars"></div>
  <div class="cu-stage"></div>

  <!-- HOME (mobile-first) -->
  <div id="homeScreen" class="min-h-full flex flex-col gap-6 p-4 sm:p-6">
    <header class="cu-header rounded-b-xl">
      <div class="cu-brand">
        <!-- logotipo simples -->
        <svg class="w-8 h-8" viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#22d3ee"/><stop offset="1" stop-color="#f472d0"/></linearGradient></defs>
          <circle cx="32" cy="32" r="30" fill="url(#g)" opacity=".25"/>
          <path d="M18 40c7 6 21 6 28 0 2-2 2-6-1-8l-4-3c-1-5-5-9-9-9s-8 4-9 9l-4 3c-3 2-3 6-1 8z" fill="url(#g)"/>
          <rect x="23" y="28" rx="4" ry="4" width="18" height="14" fill="#0b0b14"/>
          <text x="32" y="39" text-anchor="middle" font-size="9" font-family="Syne, Inter, sans-serif" fill="#fff">IDE</text>
        </svg>
        <h1 class="cu-appname">CapyIDE</h1>
        <span class="cu-chip">CapyUniverse</span>
      </div>
    </header>

    <main class="flex-1">
      <div class="cu-panel p-4 sm:p-5">
        <textarea id="promptInput" placeholder="Descreva o que você quer criar..."
          class="cu-textarea resize-y min-h-[120px] max-h-[50vh]"></textarea>

        <div class="flex flex-wrap gap-2 mt-4">
          <button class="cu-btn">Website</button>
          <button class="cu-btn">App React</button>
          <button class="cu-btn">Python</button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xs muted">
            <span>API:</span>
            <span id="apiStatus" class="inline-block w-2.5 h-2.5 bg-red-500 rounded-full"></span>
            <button id="openApiModal" class="cu-btn" style="padding:.35rem .7rem; font-size:.8rem;">Configurar API</button>
          </div>
          <button id="generateBtn" class="cu-btn primary">Gerar Código</button>
        </div>
      </div>
    </main>
  </div>

  <!-- EDITOR (mobile-first) -->
  <div id="editorScreen" class="hidden h-full w-full">
    <div class="flex flex-col h-full">
      <!-- Header compacto -->
      <header class="cu-header px-3 sm:px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <button id="backBtn" class="cu-btn" style="padding:.35rem .65rem; font-size:.85rem;">← Voltar</button>
          <h2 class="cu-appname">CapyIDE</h2>
          <span class="cu-chip hidden sm:inline-flex">IA integrada</span>
        </div>
        <div class="flex items-center gap-3">
          <button id="toggleChatMobile" class="sm:hidden cu-btn" style="padding:.35rem .6rem; font-size:.85rem;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h10v2H4v-2z"/></svg>
            Chat
          </button>
          <div class="hidden sm:flex items-center gap-2 text-xs">
            <span class="muted">Monaco:</span>
            <span id="monacoStatus" class="inline-block w-2.5 h-2.5 bg-yellow-500 rounded-full" title="Aguardando"></span>
          </div>
          <button id="openApiModalEditor" class="hidden sm:inline-flex cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">
            Configurar API
          </button>
        </div>
      </header>

      <!-- Área principal -->
      <div class="relative flex-1 min-h-0 sm:grid sm:grid-cols-[20rem_1fr]">
        <!-- Chat drawer (mobile) + sidebar (desktop) -->
        <aside id="chatPanel"
               class="fixed inset-y-0 left-0 w-full max-w-sm cu-panel z-40 transform -translate-x-full transition-transform duration-200 ease-out
                      sm:static sm:transform-none sm:translate-x-0 sm:w-80 sm:max-w-none sm:h-full sm:min-h-0 sm:overflow-hidden">
          <div class="h-full min-h-0 flex flex-col">
            <div class="cu-panel-header">
              <h3 class="font-semibold">Chat com IA</h3>
              <button id="closeChatMobile" class="sm:hidden cu-btn" style="padding:.3rem .6rem; font-size:.8rem;">Fechar</button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-3 border-t border-white/10">
              <div class="flex gap-2">
                <input id="chatInput" type="text" placeholder="Pergunte algo..." class="cu-input" />
                <button id="sendChatBtn" class="cu-btn primary" style="padding:.6rem 1rem;">→</button>
              </div>
            </div>
          </div>
        </aside>
        <!-- Overlay do drawer -->
        <div id="chatOverlay" class="hidden fixed inset-0 bg-black/50 z-30 sm:hidden"></div>

        <!-- Editor + Preview -->
        <section class="h-full min-h-0">
          <!-- Tabs -->
          <div class="px-3 sm:px-4 py-2 flex items-center gap-2">
            <div class="cu-tabs">
              <button id="codeTab" class="cu-tab active">Código</button>
              <button id="previewTab" class="cu-tab">Preview</button>
            </div>
            <div class="ml-auto flex items-center gap-2">
              <button id="copyBtn" class="cu-btn" style="padding:.45rem .8rem;">Copiar</button>
              <button id="downloadBtn" class="cu-btn" style="padding:.45rem .8rem;">Download</button>
            </div>
          </div>

          <!-- Conteúdo -->
          <div id="editorContent" class="relative h-[calc(100%-48px)] sm:h-[calc(100%-48px)]">
            <div id="monacoEditor" class="absolute inset-0 cu-editor"></div>
            <textarea id="fallbackEditor" class="absolute inset-0"></textarea>
            <div id="previewContainer" class="absolute inset-0 hidden">
              <iframe id="previewFrame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
          </div>
        </section>
      </div>

      <!-- Barra inferior mobile -->
      <nav class="sm:hidden fixed bottom-0 inset-x-0 bg-black/80 backdrop-blur border-t border-white/10 flex items-center justify-between px-3 py-2">
        <button id="mobileCode" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">Código</button>
        <button id="mobilePreview" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">Preview</button>
        <button id="mobileChat" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">Chat</button>
      </nav>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="text-center cu-panel p-6">
      <div class="animate-spin w-8 h-8 border-2 border-t-transparent rounded-full mx-auto mb-4"
           style="border-color:#22d3ee; border-top-color:transparent"></div>
      <p>Gerando código...</p>
    </div>
  </div>

  <!-- MODAL: Configurar API -->
  <div id="apiModal" class="hidden fixed inset-0 z-[60]">
    <div id="apiModalBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-4 top-16 sm:left-1/2 sm:-translate-x-1/2 sm:w-[460px] cu-panel overflow-hidden">
      <div class="cu-panel-header justify-between">
        <h3 class="font-semibold">Configurar API (Google AI Studio)</h3>
        <button id="apiModalClose" class="cu-btn" style="padding:.25rem .6rem; font-size:.85rem;">✕</button>
      </div>
      <div class="p-4 space-y-4 text-sm">
        <p>Para gerar código, cole sua <strong>chave gratuita</strong> do Google AI Studio (Gemini):</p>
        <ol class="list-decimal list-inside muted space-y-1">
          <li>Acesse <span class="underline">ai.google.dev</span> → “Get API Key”.</li>
          <li>Crie uma chave e copie o token.</li>
          <li>Cole abaixo e clique em <em>Salvar</em>.</li>
        </ol>
        <input id="apiKeyInput" type="password" placeholder="Cole sua API Key aqui" class="cu-input" />
        <div class="flex justify-end gap-2">
          <button id="apiModalCancel" class="cu-btn">Cancelar</button>
          <button id="apiModalSave" class="cu-btn primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ====== Estado (igual ao seu, preservado) ====== */
    let editor; let usingFallback = false; let apiKey = localStorage.getItem('gemini_api_key');
    let currentCode = ''; let previewTimer; let pendingCodeQueue = [];
    let lastGen = { prompt: '', code: '' };

    /* ====== Utils ====== */
    function sanitizeText(text) { const div = document.createElement('div'); div.textContent = text ?? ''; return div.innerHTML; }
    function toast(msg) { const el = document.createElement('div'); el.className = 'fixed bottom-16 right-4 bg-zinc-800 text-white text-sm px-4 py-2 rounded shadow-lg border border-zinc-700 z-[70]'; el.textContent = msg; document.body.appendChild(el); setTimeout(() => el.remove(), 2200); }
    function schedulePreview(){ if (previewTimer) cancelAnimationFrame(previewTimer); previewTimer = requestAnimationFrame(updatePreview); }
    function isFullHtml(doc){ return /<!doctype/i.test(doc) || /<\s*html[\s>]/i.test(doc); }
    function isGenerateIntent(text){ const t=(text||'').toLowerCase(); const keywords=['gera','gerar','cria','criar','constroi','constrói','build','generate','faça um','faça uma','html','<html','<!doctype','```html']; return keywords.some(k=>t.includes(k)); }
    function isEditIntent(text){ const t=(text||'').toLowerCase(); const keys=['altere','mude','modifique','ajuste','adicione','remova','troque','refatore','melhore','continue','implemente','coloque','tirar','inserir']; return keys.some(k=>t.includes(k)); }

    /* ====== DOM ====== */
    const el = (id)=>document.getElementById(id);
    const elements = {
      homeScreen: el('homeScreen'), editorScreen: el('editorScreen'),
      promptInput: el('promptInput'), generateBtn: el('generateBtn'), backBtn: el('backBtn'),
      chatPanel: el('chatPanel'), chatOverlay: el('chatOverlay'), toggleChatMobile: el('toggleChatMobile'), closeChatMobile: el('closeChatMobile'),
      chatMessages: el('chatMessages'), chatInput: el('chatInput'), sendChatBtn: el('sendChatBtn'),
      codeTab: el('codeTab'), previewTab: el('previewTab'),
      mobileCode: el('mobileCode'), mobilePreview: el('mobilePreview'), mobileChat: el('mobileChat'),
      monacoEditor: el('monacoEditor'), fallbackEditor: el('fallbackEditor'),
      previewContainer: el('previewContainer'), previewFrame: el('previewFrame'),
      copyBtn: el('copyBtn'), downloadBtn: el('downloadBtn'),
      loadingOverlay: el('loadingOverlay'), apiStatus: el('apiStatus'), monacoStatus: el('monacoStatus'),
      openApiModal: el('openApiModal'), openApiModalEditor: el('openApiModalEditor'),
      apiModal: el('apiModal'), apiModalBackdrop: el('apiModalBackdrop'),
      apiModalClose: el('apiModalClose'), apiModalCancel: el('apiModalCancel'),
      apiModalSave: el('apiModalSave'), apiKeyInput: el('apiKeyInput')
    };

    /* ====== API Key + Modal ====== */
    function setupApiKey(){
      if(!apiKey){ openApiDialog(); }
      elements.apiStatus.className = apiKey ? 'inline-block w-2.5 h-2.5 bg-green-500 rounded-full' : 'inline-block w-2.5 h-2.5 bg-red-500 rounded-full';
    }
    function openApiDialog(){ elements.apiKeyInput.value = apiKey || ''; elements.apiModal.classList.remove('hidden'); setTimeout(()=>elements.apiKeyInput.focus(), 50); }
    function closeApiDialog(){ elements.apiModal.classList.add('hidden'); }
    elements.openApiModal?.addEventListener('click', openApiDialog);
    elements.openApiModalEditor?.addEventListener('click', openApiDialog);
    elements.apiModalBackdrop?.addEventListener('click', closeApiDialog);
    elements.apiModalClose?.addEventListener('click', closeApiDialog);
    elements.apiModalCancel?.addEventListener('click', closeApiDialog);
    elements.apiModalSave?.addEventListener('click', ()=>{
      const k = elements.apiKeyInput.value.trim();
      if(!k){ toast('Informe uma chave válida'); return; }
      localStorage.setItem('gemini_api_key', k);
      apiKey = k;
      elements.apiStatus.className = 'inline-block w-2.5 h-2.5 bg-green-500 rounded-full';
      closeApiDialog();
      toast('API Key salva');
    });

    /* ====== Monaco & Fallback ====== */
    function setMonacoWorkers(baseUrl){
      window.MonacoEnvironment = {
        getWorkerUrl: function(moduleId,label){
          const code = `self.MonacoEnvironment={baseUrl:'${baseUrl}/'};importScripts('${baseUrl}/vs/base/worker/workerMain.js');`;
          return URL.createObjectURL(new Blob([code], {type:'text/javascript'}));
        }
      };
    }
    // Tema CapyUniverse para Monaco
    function applyMonacoTheme(){
      if(!window.monaco || !monaco.editor) return;
      monaco.editor.defineTheme('capyuniverse', {
        base: 'vs-dark', inherit: true,
        rules: [
          { token:'comment', foreground:'7f8ea3' },
          { token:'string',  foreground:'eab308' },
          { token:'number',  foreground:'67e8f9' },
          { token:'keyword', foreground:'a78bfa', fontStyle:'bold' },
          { token:'type',    foreground:'f472d0' },
          { token:'function',foreground:'22d3ee' },
        ],
        colors:{
          'editor.foreground':'#e6e6f0',
          'editor.background':'#0f1024',
          'editorLineNumber.foreground':'#596080',
          'editorLineNumber.activeForeground':'#d1d5ff',
          'editorCursor.foreground':'#22d3ee',
          'editor.selectionBackground':'#3b3f73',
          'editor.inactiveSelectionBackground':'#2a2e63',
          'editorIndentGuide.background':'#252a4f',
          'editorIndentGuide.activeBackground':'#3c4278',
          'editor.lineHighlightBackground':'#1a1e3d',
          'scrollbarSlider.background':'#5ee7f766',
          'scrollbarSlider.hoverBackground':'#f472d066',
          'scrollbarSlider.activeBackground':'#22d3eeaa',
          'editorGutter.background':'#0f1024',
          'editorWidget.background':'#0b0b14',
          'editorSuggestWidget.background':'#12142b',
          'editorSuggestWidget.selectedBackground':'#2a2e63',
        }
      });
      try{ monaco.editor.setTheme('capyuniverse'); }catch(e){}
    }

    function tryLoadMonaco(cdnBase, onSuccess, onFailure){
      try {
        require.config({ paths: { vs: cdnBase + '/vs' } });
        const css = document.getElementById('monaco-css');
        if(css) css.href = cdnBase + '/vs/editor/editor.main.css';
        setMonacoWorkers(cdnBase);
        require(['vs/editor/editor.main'], function(){
          if (elements.monacoStatus) elements.monacoStatus.className='inline-block w-2.5 h-2.5 bg-green-500 rounded-full';
          onSuccess();
        }, function(err){
          console.error('[Monaco] Falha', cdnBase, err);
          onFailure && onFailure(err);
        });
      } catch(e){
        console.error('[Monaco] Exceção', e);
        onFailure && onFailure(e);
      }
    }
    function enableFallbackEditor(){
      usingFallback = true;
      if (elements.monacoStatus) elements.monacoStatus.className='inline-block w-2.5 h-2.5 bg-red-500 rounded-full';
      elements.fallbackEditor.style.display='block';
      elements.fallbackEditor.value=currentCode||'';
      elements.fallbackEditor.addEventListener('input', ()=>{
        currentCode = elements.fallbackEditor.value;
        schedulePreview();
      });
      if (pendingCodeQueue.length){
        elements.fallbackEditor.value = pendingCodeQueue[pendingCodeQueue.length-1];
        currentCode = elements.fallbackEditor.value;
        pendingCodeQueue = [];
      }
      toast('Ativei o editor básico (fallback).');
    }
    function initMonacoOrFallback(){
      tryLoadMonaco(`https://cdn.jsdelivr.net/npm/monaco-editor@${window.MONACO_VERSION}/min`, createMonacoInstance, function(){
        tryLoadMonaco(`https://unpkg.com/monaco-editor@${window.MONACO_VERSION}/min`, createMonacoInstance, function(){
          tryLoadMonaco(`https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/${window.MONACO_VERSION}/min`, createMonacoInstance, function(){
            enableFallbackEditor();
          });
        });
      });
    }
    function createMonacoInstance(){
      try {
        applyMonacoTheme();
        editor = monaco.editor.create(elements.monacoEditor, {
          value: currentCode, language: 'html', theme: 'capyuniverse', fontSize: 14, automaticLayout: true, minimap: {enabled:false}
        });
        editor.onDidChangeModelContent(()=>{
          currentCode = editor.getValue();
          schedulePreview();
        });
        if (pendingCodeQueue.length){
          const latest = pendingCodeQueue[pendingCodeQueue.length-1];
          editor.setValue(latest);
          currentCode = latest;
          pendingCodeQueue = [];
        }
      } catch(e){
        console.error('[Monaco] Erro instanciando', e);
        enableFallbackEditor();
      }
    }
    function setEditorValue(v){
      if (usingFallback){
        elements.fallbackEditor.value = v; currentCode = v;
      } else if (editor){
        editor.setValue(v); currentCode = v;
      } else {
        pendingCodeQueue.push(v); currentCode = v;
      }
      schedulePreview();
    }
    function getEditorValue(){ return usingFallback ? elements.fallbackEditor.value : (editor ? editor.getValue() : currentCode); }

    /* ====== IA real — Gemini (preservado) ====== */
    async function callGemini(prompt, isCodeGeneration=false){
      if(!apiKey){ openApiDialog(); return 'ERRO::API_KEY_NAO_CONFIGURADA'; }
      const sys = isCodeGeneration
        ? 'Você gera APENAS código. Não use markdown. Não explique. Entregue um documento único HTML completo quando possível.'
        : 'Você é um assistente técnico. Responda em texto simples. Sem HTML.';
      const userText = isCodeGeneration
        ? `Crie um código SOMENTE em HTML completo e funcional para: ${prompt}\n\nRequisitos:\n- Sem markdown\n- CSS no <style> e JS em <script>\n- Layout responsivo e dark\n- Evite comentários longos\n- Use a fonte Inter (Google Fonts)\n- Nenhum texto fora do HTML`
        : `Contexto: Estou trabalhando em um projeto web (HTML/CSS/JS).\nPergunta: ${prompt}`;
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            systemInstruction:{ parts:[{text:sys}] },
            generationConfig:{
              temperature: isCodeGeneration?0.4:0.6, topK:40, topP:0.9, candidateCount:1,
              maxOutputTokens:4096,
              responseMimeType: 'text/plain'
            },
            contents:[{ parts:[{ text:userText }] }]
          })
        });
        const data = await response.json();
        if(!response.ok) throw new Error(data.error?.message||'Erro desconhecido');
        return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      } catch(error){
        console.error('Erro na API:', error);
        return `ERRO::${error.message}`;
      }
    }
    function extractCode(response){
      if(!response) return '';
      if (typeof response === 'string' && response.startsWith('ERRO::')) return response;
      let code = response.replace(/```[a-zA-Z]*\n?|```/g,'');
      if(isFullHtml(code)) return code.trim();
      return (`<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Projeto CapyIDE</title><style>body{font-family:Inter,system-ui,Arial;margin:0;padding:24px;background:#0b0b0b;color:#e5e7eb}</style></head><body>${code}</body></html>`).trim();
    }

    /* ====== Chat ====== */
    function addChatMessage(role, content){
      const d=document.createElement('div');
      d.className=`p-3 rounded-lg ${role==='user'?'bg-white/10':'bg-white/5'}`;
      d.innerHTML=`<div class="font-semibold text-sm mb-1">${role==='user'?'Você':'CapyIA'}</div><div class="text-sm">${sanitizeText(content)}</div>`;
      elements.chatMessages.appendChild(d);
      elements.chatMessages.scrollTop=elements.chatMessages.scrollHeight;
    }

    /* ====== Preview ====== */
    function updatePreview(){
      if(!currentCode || elements.previewContainer.classList.contains('hidden')) return;
      const doc = isFullHtml(currentCode) ? currentCode : `<!DOCTYPE html><html><head><base href="/"/></head><body>${currentCode}</body></html>`;
      elements.previewFrame.srcdoc = doc;
    }

    /* ====== Testes ====== */
    async function runTests(){
      const results=[];
      results.push({name:'Editor disponível', pass: (!!window.monaco && !!editor) || usingFallback});
      try{
        const wasHidden = elements.previewContainer.classList.contains('hidden');
        elements.previewContainer.classList.remove('hidden'); updatePreview();
        if(wasHidden) elements.previewContainer.classList.add('hidden');
        results.push({name:'Preview alterna', pass:true});
      }catch(e){ results.push({name:'Preview alterna', pass:false, info:e.message}); }
      try{
        const html = getEditorValue()||'';
        const ok = /<!doctype|<\s*html[\s>]/i.test(html);
        results.push({name:'Editor contém HTML gerado', pass: ok});
      }catch(e){ results.push({name:'Editor contém HTML gerado', pass:false, info:e.message}); }
      addChatMessage('assistant', 'Testes automáticos:\n'+results.map(r=>`${r.pass?'✅':'❌'} ${r.name}${r.info?' — '+r.info:''}`).join('\n'));
    }

    /* ====== Eventos ====== */
    elements.generateBtn.addEventListener('click', async ()=>{
      const prompt = elements.promptInput.value.trim();
      if(!prompt){ toast('Descreva o que quer criar :)'); return;}
      elements.loadingOverlay.classList.remove('hidden');
      try{
        const response = await callGemini(prompt, true);
        if (typeof response === 'string' && response.startsWith('ERRO::')) {
          addChatMessage('assistant', `Falhou ao gerar código: ${response.replace('ERRO::','')}`);
          elements.loadingOverlay.classList.add('hidden'); return;
        }
        const code = extractCode(response);
        setEditorValue(code);
        currentCode = code;
        lastGen = { prompt, code };

        elements.homeScreen.classList.add('slide-out-left');
        setTimeout(()=>{
          elements.homeScreen.classList.add('hidden');
          elements.editorScreen.classList.remove('hidden');
          elements.editorScreen.classList.add('slide-in-right');
          if (!editor && !usingFallback) initMonacoOrFallback();
          addChatMessage('user', prompt);
          addChatMessage('assistant', 'Código gerado e enviado ao editor.');
          setTimeout(runTests, 800);
        }, 220);
      }catch(err){
        addChatMessage('assistant', 'Falhou ao gerar código: '+(err?.message||'desconhecido'));
      } finally {
        elements.loadingOverlay.classList.add('hidden');
      }
    });

    // Voltar
    elements.backBtn.addEventListener('click', ()=>{
      elements.chatOverlay?.classList.add('hidden');
      elements.chatPanel?.classList.add('-translate-x-full');
      elements.homeScreen.classList.remove('slide-in-left','slide-out-left','hidden');
      elements.editorScreen.classList.remove('slide-in-right','slide-out-left');
      elements.homeScreen.classList.remove('hidden');
      elements.editorScreen.classList.add('hidden');
      elements.codeTab?.click();
    });

    // Chat
    elements.sendChatBtn.addEventListener('click', async ()=>{
      const message = elements.chatInput.value.trim();
      if(!message) return;
      addChatMessage('user', message);
      elements.chatInput.value='';

      if (lastGen.code && isEditIntent(message)) {
        const editInstruction =  `Você vai EDITAR um HTML completo existente.  Gere APENAS o HTML COMPLETO atualizado (sem markdown).  ---  HTML ATUAL:  ${getEditorValue()}  ---  INSTRUÇÕES DO USUÁRIO:  ${message}  ---  Regras: mantenha estrutura válida (<html>...), preserve o que não foi citado, tema dark e responsivo.`;
        const resp = await callGemini(editInstruction, true);
        if (typeof resp === 'string' && resp.startsWith('ERRO::')) { addChatMessage('assistant', `Falhou ao editar: ${resp.replace('ERRO::','')}`); return; }
        const newCode = extractCode(resp);
        setEditorValue(newCode); currentCode = newCode;
        lastGen = { prompt: lastGen.prompt + '\n[edição] ' + message, code: newCode };
        addChatMessage('assistant', 'Edição aplicada ao código no editor.');
        elements.codeTab.click();
        return;
      }

      if (isGenerateIntent(message)) {
        const resp = await callGemini(message, true);
        if (typeof resp === 'string' && resp.startsWith('ERRO::')) { addChatMessage('assistant', `Falhou ao gerar código: ${resp.replace('ERRO::','')}`); return; }
        const code = extractCode(resp);
        setEditorValue(code); currentCode = code;
        lastGen = { prompt: message, code };
        addChatMessage('assistant', 'Código gerado e enviado ao editor.');
        elements.codeTab.click();
        return;
      }

      const ctx = `Contexto: Projeto web HTML/CSS/JS. Pergunta: ${message}  Responda objetivo, focando em melhorias. Não gere código inteiro salvo pedido.`;
      const resp = await callGemini(ctx, false);
      addChatMessage('assistant', resp);
    });
    elements.chatInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') elements.sendChatBtn.click(); });

    // Tabs
    elements.codeTab.addEventListener('click', ()=>{
      elements.codeTab.classList.add('active'); elements.previewTab.classList.remove('active');
      elements.monacoEditor.classList.remove('hidden');
      elements.fallbackEditor.style.display = usingFallback ? 'block' : 'none';
      elements.previewContainer.classList.add('hidden');
    });
    elements.previewTab.addEventListener('click', ()=>{
      elements.previewTab.classList.add('active'); elements.codeTab.classList.remove('active');
      elements.monacoEditor.classList.add('hidden');
      elements.fallbackEditor.style.display='none';
      elements.previewContainer.classList.remove('hidden');
      updatePreview();
    });

    // Mobile toolbar
    elements.mobileCode.addEventListener('click', ()=>{ elements.codeTab.click(); });
    elements.mobilePreview.addEventListener('click', ()=>{ elements.previewTab.click(); });
    elements.mobileChat.addEventListener('click', ()=>{ openChatDrawer(); });

    // Drawer controls
    function openChatDrawer(){ elements.chatPanel.classList.remove('-translate-x-full'); elements.chatOverlay.classList.remove('hidden'); elements.chatInput?.focus(); }
    function closeChatDrawer(){ elements.chatPanel.classList.add('-translate-x-full'); elements.chatOverlay.classList.add('hidden'); }
    elements.toggleChatMobile.addEventListener('click', openChatDrawer);
    elements.closeChatMobile.addEventListener('click', closeChatDrawer);
    elements.chatOverlay.addEventListener('click', closeChatDrawer);

    // Clipboard & download
    elements.copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(getEditorValue()||''); toast('Código copiado!'); }
      catch{ toast('Não foi possível copiar.'); }
    });
    elements.downloadBtn.addEventListener('click', ()=>{
      const blob=new Blob([getEditorValue()||''],{type:'text/html'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='codigo_gerado.html'; a.click(); URL.revokeObjectURL(url);
      toast('Download iniciado');
    });

    // Atalhos
    window.addEventListener('keydown', (e)=>{
      const key=e.key.toLowerCase(); const accel=e.ctrlKey||e.metaKey;
      if(accel && key==='s'){ e.preventDefault();
        const blob=new Blob([getEditorValue()||''],{type:'text/html'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a');
        a.href=url; a.download='projeto.html'; a.click(); URL.revokeObjectURL(url);
        toast('Arquivo salvo (download)');
      }
      if(accel && key==='p'){ e.preventDefault(); elements.previewTab.click(); }
      if(e.key==='Escape'){ closeChatDrawer(); }
    });

    // Sugestões rápidas
    document.querySelectorAll('#homeScreen .cu-btn').forEach(btn=>{
      const label = btn.textContent.trim();
      if(!['Website','App React','Python'].includes(label)) return;
      btn.addEventListener('click', ()=>{
        const s={
          'Website':'Uma landing page moderna para uma empresa de tecnologia com seções hero, serviços e contato',
          'App React':'Um dashboard administrativo com gráficos, tabelas e formulários',
          'Python':'Uma página web que simula um terminal Python interativo com exemplos de código'
        };
        elements.promptInput.value = s[label] || label;
        elements.promptInput.focus();
      });
    });

    // Boot
    setupApiKey();
    elements.promptInput.placeholder='Ex.: Landing page de startup com hero, grid de features e formulário';
    setTimeout(()=>elements.promptInput.focus(), 0);
  </script>
</body>
</html>
