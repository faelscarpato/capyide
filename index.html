<!DOCTYPE html>
<html lang="pt-BR" class="h-full" data-theme="capyuniverse">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>CapyIDE - Editor de Código com IA</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Pré-configuração do AMD loader do Monaco ANTES de carregar o loader -->
  <script>
    window.MONACO_VERSION = '0.44.0';
    window.MonacoCDN = `https://cdn.jsdelivr.net/npm/monaco-editor@${window.MONACO_VERSION}/min`;
    window.require = { paths: { vs: window.MonacoCDN + '/vs' } };
  </script>

  <!-- CSS principal do Monaco (evita falha do plugin vs/css) -->
  <link id="monaco-css" rel="stylesheet" data-name="vs/editor/editor.main"
        href="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.css" />
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Syne:wght@700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <!-- ====== THEME CAPYUNIVERSE (drop-in) ====== -->
  <style id="capyuniverse-theme">
    :root[data-theme="dark"] {
      --cu-bg-0:#0b0b14; --cu-bg-1:#0f1024; --cu-bg-2:#141636;
      --cu-grid:#2a2e63; --cu-card:#0f0f22cc;
      --cu-cyan:#22d3ee; --cu-magenta:#f472d0; --cu-amber:#f59e0b; --cu-violet:#8b5cf6;
      --cu-text:#e6e6f0; --cu-text-dim:#aab;
      --cu-radius:16px; --cu-radius-lg:22px; --cu-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
      --cu-blur:12px;
    }
    
    :root[data-theme="light"] {
      --cu-bg-0:#ffffff; --cu-bg-1:#f3f4f6; --cu-bg-2:#e5e7eb;
      --cu-grid:#d1d5db; --cu-card:#ffffffcc;
      --cu-cyan:#0ea5e9; --cu-magenta:#db2777; --cu-amber:#d97706; --cu-violet:#7c3aed;
      --cu-text:#111827; --cu-text-dim:#6b7280;
      --cu-radius:16px; --cu-radius-lg:22px; --cu-shadow:0 10px 30px rgba(0,0,0,.1), inset 0 0 0 1px rgba(0,0,0,.05);
      --cu-blur:12px;
    }
    body{ font-family: 'Inter', sans-serif; background:
      radial-gradient(1200px 700px at 70% -10%, rgba(139,92,246,.25), transparent 60%),
      radial-gradient(900px 600px at -10% 20%, rgba(34,211,238,.18), transparent 60%),
      var(--cu-bg-0); color:var(--cu-text); }

    /* cenário */
    .cu-stars{ position:fixed; inset:0; pointer-events:none; z-index:-2;
      background:
        radial-gradient(circle at 15% 20%, rgba(255,255,255,.12) 0 1px, transparent 2px) 0 0/180px 180px,
        radial-gradient(circle at 75% 35%, rgba(255,255,255,.10) 0 1px, transparent 2px) 0 0/220px 220px,
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.08) 0 1px, transparent 2px) 0 0/260px 260px; }
    .cu-stage{ position:fixed; inset:auto 0 0 0; height:40vh; pointer-events:none; z-index:-1;
      background: linear-gradient( to top, rgba(10,10,22,.65), transparent 70%),
        repeating-linear-gradient( to right, transparent 0 38px, var(--cu-grid) 38px 39px),
        repeating-linear-gradient( to top,   transparent 0 38px, var(--cu-grid) 38px 39px);
      mask: linear-gradient(to top, black, transparent 80%); }

    /* header */
    .cu-header{ position:sticky; top:0; z-index:30; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(10,10,30,.7), rgba(10,10,30,.35));
      border-bottom: 1px solid rgba(255,255,255,.06); }
    .cu-brand{ display:flex; align-items:center; gap:.75rem; padding:10px 14px; }
    .cu-appname{ font-family: Syne, Inter, sans-serif; font-weight:800; letter-spacing:.4px; font-size:1.2rem; }
    .cu-chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .6rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:linear-gradient(120deg, rgba(34,211,238,.16), rgba(139,92,246,.16)); }

    /* containers */
    .cu-panel{ background:var(--cu-card); backdrop-filter: blur(var(--cu-blur));
      border-radius:var(--cu-radius-lg); box-shadow:var(--cu-shadow); border:1px solid rgba(255,255,255,.06); }
    .cu-panel-header{ display:flex; align-items:center; gap:.75rem; padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent); }

    /* botões / inputs */
    .cu-btn{ display:inline-flex; align-items:center; gap:.55rem; padding:.70rem 1rem; border-radius:var(--cu-radius);
      font-weight:600; border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(130deg, rgba(34,211,238,.18), rgba(244,114,208,.18));
      box-shadow:var(--cu-shadow); backdrop-filter: blur(6px); transition:.2s transform, .2s filter; }
    .cu-btn:hover{ transform: translateY(-1px); filter: drop-shadow(0 0 10px rgba(34,211,238,.45)) drop-shadow(0 0 24px rgba(244,114,208,.35)); }
    .cu-btn.primary{ background: linear-gradient(140deg, #0ea5e9 0%, #a855f7 45%, #f59e0b 100%); color:#fff; border-color:transparent; }
    .cu-input, .cu-textarea { width:100%; background:rgba(15,15,40,.6); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:.75rem .9rem; color:var(--cu-text); outline:none; }
    .cu-input:focus, .cu-textarea:focus { border-color: var(--cu-cyan); box-shadow: 0 0 0 3px rgba(34,211,238,.18); }

    /* tabs */
    .cu-tabs{ display:flex; gap:.35rem; align-items:center; padding:.4rem; background:rgba(255,255,255,.04);
      border-radius:12px; border:1px solid rgba(255,255,255,.06); }
    .cu-tab{ padding:.5rem .75rem; border-radius:10px; color:var(--cu-text-dim); border:1px solid transparent; cursor:pointer; }
    .cu-tab.active{ color:#fff; background:linear-gradient(120deg, rgba(34,211,238,.22), rgba(244,114,208,.22));
      border:1px solid rgba(255,255,255,.12); }

    /* editor/console */
    .cu-editor{ background:var(--cu-bg-1); border-radius:14px; border:1px solid rgba(255,255,255,.08); box-shadow:var(--cu-shadow); overflow:hidden; }
    .cu-output{ background:rgba(10,10,28,.8); border:1px solid rgba(255,255,255,.08); border-radius:14px; box-shadow:var(--cu-shadow); overflow:auto; }
    .cu-output pre{ font-family:"JetBrains Mono", ui-monospace, Menlo, Consolas, monospace; font-size:.9rem; line-height:1.5; padding:1rem; }

    /* monaco tweaks */
    [data-theme="dark"] .monaco-editor, 
    [data-theme="dark"] .monaco-editor-background { background-color:#0f1024 !important; }
    [data-theme="dark"] .monaco-editor .margin { background-color:#0f1024 !important; }
    [data-theme="dark"] .monaco-editor .current-line { background-color: rgba(255,255,255,.04) !important; }
    [data-theme="dark"] .monaco-editor .scrollbar > .slider { background:linear-gradient(120deg, #22d3ee, #f472d0) !important; }
    
    [data-theme="light"] .monaco-editor,
    [data-theme="light"] .monaco-editor-background { background-color:#f3f4f6 !important; }
    [data-theme="light"] .monaco-editor .margin { background-color:#f3f4f6 !important; }
    [data-theme="light"] .monaco-editor .current-line { background-color: rgba(0,0,0,.03) !important; }
    [data-theme="light"] .monaco-editor .scrollbar > .slider { background:linear-gradient(120deg, #0ea5e9, #db2777) !important; }

    /* animações originais */
    .slide-out-left { animation: slideOutLeft 0.4s ease-in-out forwards; }
    .slide-in-right { animation: slideInRight 0.4s ease-in-out forwards; }
    .slide-in-left { animation: slideInLeft 0.4s ease-in-out forwards; }
    @keyframes slideOutLeft { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* util */
    .muted{ color:var(--cu-text-dim); }
  </style>

  <style>
    #previewFrame { width: 100%; height: 100%; border: none; background: white; }
    #generateBtn { transition: all 0.25s ease; transform: scale(1); }
    #generateBtn:hover { transform: scale(1.03); box-shadow: 0 8px 25px rgba(163, 230, 53, 0.25); }
    #generateBtn:active { transform: scale(0.98); }
    #fallbackEditor { display:none; width:100%; height:100%; background:#0b0b0b; color:#e5e7eb; border:none; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:14px; }
  </style>
</head>
<body class="text-white h-full overflow-hidden">
  <!-- cenário -->
  <div class="cu-stars"></div>
  <div class="cu-stage"></div>

  <!-- HOME (mobile-first) -->
  <div id="homeScreen" class="min-h-full flex flex-col gap-6 p-4 sm:p-6">
    <header class="cu-header rounded-b-xl">
      <div class="cu-brand">
        <!-- logotipo simples -->
        <svg class="w-8 h-8" viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#22d3ee"/><stop offset="1" stop-color="#f472d0"/></linearGradient></defs>
          <circle cx="32" cy="32" r="30" fill="url(#g)" opacity=".25"/>
          <path d="M18 40c7 6 21 6 28 0 2-2 2-6-1-8l-4-3c-1-5-5-9-9-9s-8 4-9 9l-4 3c-3 2-3 6-1 8z" fill="url(#g)"/>
          <rect x="23" y="28" rx="4" ry="4" width="18" height="14" fill="#0b0b14"/>
          <text x="32" y="39" text-anchor="middle" font-size="9" font-family="Syne, Inter, sans-serif" fill="#fff">IDE</text>
        </svg>
        <h1 class="cu-appname">CapyIDE</h1>
        <span class="cu-chip">CapyUniverse</span>
      </div>
    </header>

    <main class="flex-1">
      <div class="cu-panel p-4 sm:p-5">
        <textarea id="promptInput" placeholder="Descreva o que você quer criar..."
          class="cu-textarea resize-y min-h-[120px] max-h-[50vh]"></textarea>

        <div class="flex flex-wrap gap-2 mt-4">
          <button class="cu-btn">Website</button>
          <button class="cu-btn">App React</button>
          <button class="cu-btn">Python</button>
        </div>

        <div class="mt-4 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xs muted">
            <span>API:</span>
            <span id="apiStatus" class="inline-block w-2.5 h-2.5 bg-red-500 rounded-full"></span>
            <button id="openApiModal" class="cu-btn" style="padding:.35rem .7rem; font-size:.8rem;">Configurar API</button>
          </div>
          <button id="generateBtn" class="cu-btn primary">Gerar Código</button>
        </div>
      </div>
    </main>
  </div>

  <!-- EDITOR (mobile-first) -->
  <div id="editorScreen" class="hidden h-full w-full">
    <div class="flex flex-col h-full">
      <!-- Header compacto -->
      <header class="cu-header px-3 sm:px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <button id="backBtn" class="cu-btn" style="padding:.35rem .65rem; font-size:.85rem;">← Voltar</button>
          <h2 class="cu-appname">CapyIDE</h2>
          <span class="cu-chip hidden sm:inline-flex">IA integrada</span>
        </div>
        <div class="flex items-center gap-3">
          <button id="themeToggle" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">🌙</button>
          <button id="toggleChatMobile" class="sm:hidden cu-btn" style="padding:.35rem .6rem; font-size:.85rem;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h10v2H4v-2z"/></svg>
            Chat
          </button>
          <div class="hidden sm:flex items-center gap-2 text-xs">
            <span class="muted">Monaco:</span>
            <span id="monacoStatus" class="inline-block w-2.5 h-2.5 bg-yellow-500 rounded-full" title="Aguardando"></span>
          </div>
          <button id="openApiModalEditor" class="hidden sm:inline-flex cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">
            Configurar API
          </button>
        </div>
      </header>

      <!-- Área principal -->
      <div class="relative flex-1 min-h-0 sm:grid sm:grid-cols-[20rem_1fr]">
        <!-- Chat drawer (mobile) + sidebar (desktop) -->
        <aside id="chatPanel"
               class="fixed inset-y-0 left-0 w-full max-w-sm cu-panel z-40 transform -translate-x-full transition-transform duration-200 ease-out
                      sm:static sm:transform-none sm:translate-x-0 sm:w-80 sm:max-w-none sm:h-full sm:min-h-0 sm:overflow-hidden">
          <div class="h-full min-h-0 flex flex-col">
            <div class="cu-panel-header">
              <h3 class="font-semibold">Chat com IA</h3>
              <button id="closeChatMobile" class="sm:hidden cu-btn" style="padding:.3rem .6rem; font-size:.8rem;">Fechar</button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-3 border-t border-white/10">
              <div class="flex gap-2">
                <input id="chatInput" type="text" placeholder="Pergunte algo..." class="cu-input" />
                <button id="sendChatBtn" class="cu-btn primary" style="padding:.6rem 1rem;">→</button>
              </div>
            </div>
          </div>
        </aside>
        <!-- Overlay do drawer -->
        <div id="chatOverlay" class="hidden fixed inset-0 bg-black/50 z-30 sm:hidden"></div>

        <!-- Editor + Preview -->
        <section class="h-full min-h-0">
          <!-- Tabs -->
          <div class="px-3 sm:px-4 py-2 flex items-center gap-2">
            <div class="cu-tabs">
              <button id="codeTab" class="cu-tab active">Código</button>
              <button id="previewTab" class="cu-tab">Preview</button>
            </div>
            <div class="ml-auto flex items-center gap-2">
              <button id="formatBtn" class="cu-btn" style="padding:.45rem .8rem;">Formatar</button>
              <button id="copyBtn" class="cu-btn" style="padding:.45rem .8rem;">Copiar</button>
              <button id="downloadBtn" class="cu-btn" style="padding:.45rem .8rem;">Download</button>
            </div>
          </div>

          <!-- Conteúdo -->
          <div id="editorContent" class="relative h-[calc(100%-48px)] sm:h-[calc(100%-48px)]">
            <div id="monacoEditor" class="absolute inset-0 cu-editor"></div>
            <textarea id="fallbackEditor" class="absolute inset-0"></textarea>
            <div id="previewContainer" class="absolute inset-0 hidden">
              <iframe id="previewFrame" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
          </div>
        </section>
      </div>

      <!-- Barra inferior mobile -->
      <nav class="sm:hidden fixed bottom-0 inset-x-0 bg-black/80 backdrop-blur border-t border-white/10 flex items-center justify-between px-3 py-2">
        <button id="mobileCode" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">Código</button>
        <button id="mobilePreview" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">Preview</button>
        <button id="mobileChat" class="cu-btn" style="padding:.35rem .7rem; font-size:.85rem;">Chat</button>
      </nav>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="text-center cu-panel p-6">
      <div class="animate-spin w-8 h-8 border-2 border-t-transparent rounded-full mx-auto mb-4"
           style="border-color:#22d3ee; border-top-color:transparent"></div>
      <p>Gerando código...</p>
    </div>
  </div>

  <!-- MODAL: Configurar API -->
  <div id="apiModal" class="hidden fixed inset-0 z-[60]">
    <div id="apiModalBackdrop" class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-4 top-16 sm:left-1/2 sm:-translate-x-1/2 sm:w-[460px] cu-panel overflow-hidden">
      <div class="cu-panel-header justify-between">
        <h3 class="font-semibold">Configurar API (Google AI Studio)</h3>
        <button id="apiModalClose" class="cu-btn" style="padding:.25rem .6rem; font-size:.85rem;">✕</button>
      </div>
      <div class="p-4 space-y-4 text-sm">
        <p>Para gerar código, cole sua <strong>chave gratuita</strong> do Google AI Studio (Gemini):</p>
        <ol class="list-decimal list-inside muted space-y-1">
          <li>Acesse <span class="underline">https://aistudio.google.com/apikey</span> → “Get API Key”.</li>
          <li>Crie uma chave e copie o token.</li>
          <li>Cole abaixo e clique em <em>Salvar</em>.</li>
        </ol>
        <input id="apiKeyInput" type="password" placeholder="Cole sua API Key aqui" class="cu-input" />
        <div class="flex justify-end gap-2">
          <button id="apiModalCancel" class="cu-btn">Cancelar</button>
          <button id="apiModalSave" class="cu-btn primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./js/app.js"></script>
</body>
</html>
